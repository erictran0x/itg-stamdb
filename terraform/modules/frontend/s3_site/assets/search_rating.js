import{S as C,n as y,s as q,r as x,u as j,a as d,b as P,c as M,j as b}from"./index.js";import{A as k,a as L,b as A,P as _}from"./PageMainDatabase.js";import{Q,a as B,b as H,e as T,c as I,d as U,s as w,f as S,w as z,g as D}from"./useQuery.js";import"./create-slot-recipe-context.js";function E(e,s){const n=new Set(s);return e.filter(t=>!n.has(t))}function F(e,s,n){const t=e.slice(0);return t[s]=n,t}var K=class extends C{#r;#s;#n;#i;#e;#t;#o;#u;#a=[];constructor(e,s,n){super(),this.#r=e,this.#i=n,this.#n=[],this.#e=[],this.#s=[],this.setQueries(s)}onSubscribe(){this.listeners.size===1&&this.#e.forEach(e=>{e.subscribe(s=>{this.#f(e,s)})})}onUnsubscribe(){this.listeners.size||this.destroy()}destroy(){this.listeners=new Set,this.#e.forEach(e=>{e.destroy()})}setQueries(e,s){this.#n=e,this.#i=s,y.batch(()=>{const n=this.#e,t=this.#l(this.#n);this.#a=t,t.forEach(u=>u.observer.setOptions(u.defaultedQueryOptions));const r=t.map(u=>u.observer),a=r.map(u=>u.getCurrentResult()),o=n.length!==r.length,c=r.some((u,f)=>u!==n[f]),i=o||c,g=i?!0:a.some((u,f)=>{const m=this.#s[f];return!m||!q(u,m)});!i&&!g||(i&&(this.#e=r),this.#s=a,this.hasListeners()&&(i&&(E(n,r).forEach(u=>{u.destroy()}),E(r,n).forEach(u=>{u.subscribe(f=>{this.#f(u,f)})})),this.#p()))})}getCurrentResult(){return this.#s}getQueries(){return this.#e.map(e=>e.getCurrentQuery())}getObservers(){return this.#e}getOptimisticResult(e,s){const n=this.#l(e),t=n.map(r=>r.observer.getOptimisticResult(r.defaultedQueryOptions));return[t,r=>this.#c(r??t,s),()=>this.#h(t,n)]}#h(e,s){return s.map((n,t)=>{const r=e[t];return n.defaultedQueryOptions.notifyOnChangeProps?r:n.observer.trackResult(r,a=>{s.forEach(o=>{o.observer.trackProp(a)})})})}#c(e,s){return s?((!this.#t||this.#s!==this.#u||s!==this.#o)&&(this.#o=s,this.#u=this.#s,this.#t=x(this.#t,s(e))),this.#t):e}#l(e){const s=new Map;this.#e.forEach(t=>{const r=t.options.queryHash;if(!r)return;const a=s.get(r);a?a.push(t):s.set(r,[t])});const n=[];return e.forEach(t=>{const r=this.#r.defaultQueryOptions(t),o=s.get(r.queryHash)?.shift()??new Q(this.#r,r);n.push({defaultedQueryOptions:r,observer:o})}),n}#f(e,s){const n=this.#e.indexOf(e);n!==-1&&(this.#s=F(this.#s,n,s),this.#p())}#p(){if(this.hasListeners()){const e=this.#t,s=this.#h(this.#s,this.#a),n=this.#c(s,this.#i?.combine);e!==n&&y.batch(()=>{this.listeners.forEach(t=>{t(this.#s)})})}}};function W({queries:e,...s},n){const t=j(),r=B(),a=H(),o=d.useMemo(()=>e.map(h=>{const p=t.defaultQueryOptions(h);return p._optimisticResults=r?"isRestoring":"optimistic",p}),[e,t,r]);o.forEach(h=>{T(h),I(h,a)}),U(a);const[c]=d.useState(()=>new K(t,o,s)),[i,g,u]=c.getOptimisticResult(o,s.combine),f=!r&&s.subscribed!==!1;d.useSyncExternalStore(d.useCallback(h=>f?c.subscribe(y.batchCalls(h)):P,[c,f]),()=>c.getCurrentResult(),()=>c.getCurrentResult()),d.useEffect(()=>{c.setQueries(o,s)},[o,s,c]);const R=i.some((h,p)=>w(o[p],h))?i.flatMap((h,p)=>{const l=o[p];if(l){const v=new Q(t,l);if(w(l,h))return S(l,v,a);z(h,r)&&S(l,v,a)}return[]}):[];if(R.length>0)throw Promise.all(R);const O=i.find((h,p)=>{const l=o[p];return l&&D({result:h,errorResetBoundary:a,throwOnError:l.throwOnError,query:t.getQueryCache().get(l.queryHash),suspense:l.suspense})});if(O?.error)throw O.error;return g(u())}function V(){const{rating:e,bpm_from:s,bpm_to:n,show_neighboring:t}=M.useSearch(),r=new URLSearchParams({rating:e.toString(),bpm_from:s.toString(),bpm_to:n.toString(),show_neighboring:t.toString()}),o=W({queries:(t?[-1,0,1]:[0]).map(i=>({queryKey:["query",e+i,s,n],queryFn:async()=>(r.set("rating",(e+i).toString()),(await(await fetch(`https://d2xk0hpalqd86m.cloudfront.net/api/query?${r.toString()}`)).json()).response)}))});if(o.some(i=>i.isLoading))return b.jsx("div",{children:"Loading data..."});if(o.some(i=>i.isError))return o.filter(i=>i.isError).map(({error:i})=>b.jsxs(k,{status:"error",children:[b.jsx(L,{}),b.jsxs(A,{children:[i.name,": ",i.message]})]}));const c=o.flatMap(i=>i.data);return b.jsx(_,{data:c})}export{V as component};
